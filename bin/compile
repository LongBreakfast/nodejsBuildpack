
#!/bin/bash
set -euo pipefail

# Define build variables
BUILD_DIR=$1
CACHE_DIR=$2
export BUILDPACK_DIR=$(dirname "$(readlink -f "${BASH_SOURCE%/*}")")
export DEPS_DIR="$BUILD_DIR/.cloudfoundry"
export BTP_CLI_INSTALL_DIR="$BUILD_DIR/btp-cli"

# Create necessary directories
mkdir -p "$DEPS_DIR/0"
mkdir -p "$BUILD_DIR/.profile.d"

# Set up script to update PATH variable
echo 'export PATH="$BTP_CLI_INSTALL_DIR:$PATH"' > "$BUILD_DIR/.profile.d/set-path.sh"
chmod +x "$BUILD_DIR/.profile.d/set-path.sh"

# Debug: Print out build variables
echo "BUILD_DIR: $BUILD_DIR"
echo "CACHE_DIR: $CACHE_DIR"
echo "BUILDPACK_DIR: $BUILDPACK_DIR"
echo "DEPS_DIR: $DEPS_DIR"
echo "BTP_CLI_INSTALL_DIR: $BTP_CLI_INSTALL_DIR"

# Install BTP CLI
echo "Installing BTP CLI..."
mkdir -p "$BTP_CLI_INSTALL_DIR"
curl -LJO https://tools.hana.ondemand.com/additional/btp-cli-linux-amd64-latest.tar.gz --cookie "eula_3_1_agreed=tools.hana.ondemand.com/developer-license-3_1.txt"
tar -xzf btp-cli-linux-amd64-latest.tar.gz -C "$BTP_CLI_INSTALL_DIR" --strip-components=1
chmod +x "$BTP_CLI_INSTALL_DIR/btp"

# Debug: Verify BTP CLI installation
echo "Contents of BTP_CLI_INSTALL_DIR..."
ls -la "$BTP_CLI_INSTALL_DIR"

# Run buildpack scripts
$BUILDPACK_DIR/bin/supply "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" 0
$BUILDPACK_DIR/bin/finalize "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" 0
