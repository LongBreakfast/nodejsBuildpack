#!/bin/bash
set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
export BUILDPACK_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`
export DEPS_DIR="$BUILD_DIR/.cloudfoundry"
mkdir -p "$DEPS_DIR/0"
mkdir -p "$BUILD_DIR/.profile.d"
echo "export DEPS_DIR=\$HOME/.cloudfoundry" > "$BUILD_DIR/.profile.d/0000_set-deps-dir.sh"

# Define the BTP CLI installation directory
BTP_CLI_INSTALL_DIR="$BUILD_DIR/btp-cli"

# Ensure the installation directory exists
mkdir -p "$BTP_CLI_INSTALL_DIR" || { echo "Failed to create directory $BTP_CLI_INSTALL_DIR"; exit 1; }

# Download and install the BTP CLI
curl -LJO https://tools.hana.ondemand.com/additional/btp-cli-linux-amd64-latest.tar.gz --cookie "eula_3_1_agreed=tools.hana.ondemand.com/developer-license-3_1.txt"
tar -xzf btp-cli-linux-amd64-latest.tar.gz -C "$BTP_CLI_INSTALL_DIR" --strip-components=1
chmod +x "$BTP_CLI_INSTALL_DIR/btp"

# Update the PATH environment variable to include the BTP CLI installation directory
export PATH="$BTP_CLI_INSTALL_DIR:$PATH"

$BUILDPACK_DIR/bin/supply "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" 0
$BUILDPACK_DIR/bin/finalize "$BUILD_DIR" "$CACHE_DIR" "$DEPS_DIR" 0
